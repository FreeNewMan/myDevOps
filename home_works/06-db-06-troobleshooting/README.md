# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя
>Надо убедиться в том, что проблема действительно существует. Нужно это увидеть на рабочем месте пользоввателя и как-то образом обнаружить долгоживущию активную сессию с помощью средств мониторинга и ее прервать.
>Как вариант, влючить мониторинг **db.enableFreeMonitoring()**. И по предложенной в ответ ссылки найти id сессии и ее прервать
**db.runCommand( { killSessions: [ { id : <UUID> }, ... ] } )**
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB
>Каждый запрос нужно отдельно анализировать и проблема решается созданием дополнительных индексов, оптимизацией смаого запроса, разбиением таблиц, увеличением ресурсов выделяемых СУБД.
> Долгие запросы (например длящиеся более 3 секунд) можно выявить с помощью команды:
> db.currentOp( 
   {
     "active" : true,
     "secs_running" : { "$gt" : 3 },
     "ns" : /^db1\./
   }
)
## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
>Ответ: Если это связано с увеличеним количества реплик, то верятно тратится время на репликацию. Предположу,  что это время может добавляеться к времени жизни значения. Чем больше репик тем больше "добавленное" время жизни сообащения в таком случае. Поэтому, при добавлении реплик нужно корректировать TTL.

- Redis блокирует операции записи
>Ответ: Т.к. Redis это система активно использующая оперативную память ресурса, за чет чего обеспечивается высокая скорость записи и чтения данных, то блокировка может возникать при исчерпании ресурса памяти - негде хранить новые данные.

Как вы думаете, в чем может быть проблема?


 
## Задача 3

Перед выполнением задания познакомьтесь с документацией по [Common Mysql errors](https://dev.mysql.com/doc/refman/8.0/en/common-errors.html).

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?
>Ответ: Вероятно, сервер СУБД отключает сессию по таймаунту чтения/записи данных. То есть если запрос не отдал какой-то результат по истечении определенного времени указанного в настройках, то эта сессия убивается.



Какие пути решения данной проблемы вы можете предложить?
>Нужно выяснить какие именно запросы взывают такую проблему. Это можно выяснить включив slow-log или промониторить сессии. Сразу можно сделать EXPLAIN этих запросов, создать дополнительные индексы, собрать статистику по таблице ANALYZE, рассмотреть вариант шардирования. Также можно проанализировать запрос на премет оптимизации, возможноно разденения на несколько запросов (это уже надо взаимодействовать с разработчиком).



## Задача 4

Перед выполнением задания ознакомтесь со статьей [Common PostgreSQL errors](https://www.percona.com/blog/2020/06/05/10-common-postgresql-errors/) из блога Percona.

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?
>Эта ошибка возникает если какая-то сессия съедает всю память сервера и сервер ее убивает чтобы другие могли работать с системой. Каждая СУБД имеет свои особенности в архитектуре, а значит SQL-код может не всегда работать быстрее при тех же алгоритмах его использования, но в другой СУБД. То что работало медленно, не факт что будет работать быстрее на другой СУБД даже если она и быстрее. Нужно адаптировать код под новую СУБД используя те фичи которые и делают ее быстрее других. 

>Первое что можно сделать, это проверить настройки СУБД, что они действительно настроены на Production окружение (не дефолтные). Второе поставить пуллер запросов pgbouncer - он ускорит выполнение запросов снизив (оптимизировав) количество сессий для работы с СУБД, Также pgbouncer возьмет на себя обработку длительных запросов, сняв нагрузку на СУБД, другие пользователи будет работать дальше.

Как бы вы решили данную проблему?

---

### Как cдавать задание

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
